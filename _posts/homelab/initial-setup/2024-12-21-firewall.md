---
title: "Firewall Configurations"
date: 2024-12-21 00:00:00 -0800
categories: [Cybersecurity Lab, Initial Setup]
tags: [cybersecurity, homelab]
description: Configuring OPNsense for routing and Internet connectivity for all VMs.
---

# Firewall Configurations

On the Ubuntu VM, head to the OPNsense dashboard by entering the gateway IP (10.10.3.1)

If you get this message, just click **Advanced > Accept the Risk and Continue**

Log in using the credentials

**user**: root

**password**: opnsense (default)

![1](/assets/img/cyberlab/setup/routing/1.png){: width="600" height="400" }

We should be presented with a dashboard like this

![2](/assets/img/cyberlab/setup/routing/2.png){: width="900" height="400" }

### Guest Additions Installation

Head to **System > Firmware > Status**

Click Check for Updates

![3](/assets/img/cyberlab/setup/routing/3.png){: width="600" height="400" }

Update

![4](/assets/img/cyberlab/setup/routing/4.png){: width="600" height="400" }

This should not take too long

![5](/assets/img/cyberlab/setup/routing/5.png){: width="600" height="400" }

Everything should now be up to date

![6](/assets/img/cyberlab/setup/routing/6.png){: width="600" height="400" }

Stay on **System > Firmware**

Head to Plugins and Install Vbox guest additions (os-virtualbox)

Click the “+” button on the far right

![7](/assets/img/cyberlab/setup/routing/7.png){: width="900" height="400" }

Done

![8](/assets/img/cyberlab/setup/routing/8.png){: width="600" height="400" }

### Adapter Assignments

Head to **Interfaces > Assignments**

Add em1 (this should be internal network: cyberlab-servers)

Make sure the MAC address of the device (em1) matches the MAC address of Adapter 2 of the OPNsense VM (cyberlab-servers)

Give the interface a name (servers)

![9](/assets/img/cyberlab/setup/routing/9.png){: width="900" height="400" }

Add em2 (this should be internal network: cyberlab-ad)

Again, make sure the MAC addresses match and give the interface a name

![10](/assets/img/cyberlab/setup/routing/10.png){: width="900" height="400" }

### Active Directory Interface

Click the Active Directory interface from the left hand side under **Interfaces**

Enable this interface

Set the IP to static 

Do not configure IPv6

![11](/assets/img/cyberlab/setup/routing/11.png){: width="900" height="400" }

Set the IP of the interface to 10.10.2.1/24

Leave IPv4 gateway rules disabled

Save and apply

![12](/assets/img/cyberlab/setup/routing/12.png){: width="600" height="400" }

### Servers Interface

Click the Servers interface under **Interfaces**

Enable this interface

Set the IP to static 

Do not configure IPv6

![13](/assets/img/cyberlab/setup/routing/13.png){: width="900" height="400" }

Change the IP to 10.10.1.1/24

Leave IPv4 gateway rules disabled

Save and apply

![14](/assets/img/cyberlab/setup/routing/14.png){: width="600" height="400" }

Head to **Interfaces > Overview**

It should look like this

I renamed the LAN interface to Admin (10.10.3.1/24)

![15](/assets/img/cyberlab/setup/routing/15.png){: width="900" height="400" }

### Routing Rules

Head to **Firewall > Rules > Servers**

Click the orange (+) button to add a new rule

![16](/assets/img/cyberlab/setup/routing/16.png){: width="900" height="400" }

The rule should look like this:

**Action:** Pass

**Interface:** Servers

**Direction:** in

**TCP/IP Version:** IPv4

**Protocol:** any

**Source:** Servers net

**Destination:** any

Save

![17](/assets/img/cyberlab/setup/routing/17.png){: width="900" height="400" }

This rule basically gives the Servers network (10.10.1.0) access to the Internet through the OPNsense router

Apply changes

![18](/assets/img/cyberlab/setup/routing/18.png){: width="900" height="400" }

Follow the same process for the AD Clients net

Head to **Firewall > Rules > ActiveDirectory**

**Action:** Pass

**Interface:** ActiveDirectory

**Direction:** in

**TCP/IP Version:** IPv4

**Protocol:** any

**Source:** ActiveDirectory net

**Destination:** any

Save

![19](/assets/img/cyberlab/setup/routing/19.png){: width="900" height="400" }

Looks good

![20](/assets/img/cyberlab/setup/routing/20.png){: width="900" height="400" }

For Admin, head to **Firewall > Rules > Admin**

> The default routing rule for Internet connectivity is already applied since we chose this network (10.10.3.0) to be the LAN during the OPNsense installation.
> Nothing more has to be done for now. If this is not the case for you, then just follow the same steps as before.
{: .prompt-info }

![21](/assets/img/cyberlab/setup/routing/21.png){: width="900" height="400" }

### DNS

Head to **System > Settings > General**

Under Networking, enter your DNS server of choice

I chose 8.8.8.8

Use the WAN gateway

![22](/assets/img/cyberlab/setup/routing/22.png){: width="900" height="400" }

Now shut off the Ubuntu VM and disable the NAT adapter

The Ubuntu VM should only have 1 adapter (cyberlab-admin)

![23](/assets/img/cyberlab/setup/routing/23.png){: width="500" height="400" }

Reboot the VM and open a terminal

Run ``ip a``

The VM should only have 1 IP address (10.10.3.11 in my case)

We should also be able to ping the gateway and the DNS server

All of our VMs should be able to connect to the Internet through OPNsense

![24](/assets/img/cyberlab/setup/routing/24.png){: width="900" height="400" }

### **Next**: [Active Directory: Domain Controller Setup](/posts/domain-controller)