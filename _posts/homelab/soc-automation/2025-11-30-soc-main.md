---
title: "SOC Automation"
date: 2025-11-30 00:00:00 -0800
categories: [Cybersecurity Lab, SOC Automation, Blue Team Exercises]
tags: [cybersecurity, homelab, automation]
description: Configuring a Wazuh Active Response rule to quarantine an endpoint + a Shuffle workflow that creates a case on TheHive and sends an email alert.
pin: true
---

### Objectives

In this project, we will configure a Wazuh Active Response (AR) rule to quarantine an endpoint that has Mimikatz activity detected on it, plus a Shuffle workflow that creates a case on TheHive and sends an email alert about the incident. This basically simulates the containment phase of incident response.
>This is mainly a proof of concept and does not address any specific scenarios. There will always be something to consider and something to improve.
{: .prompt-info}

The Shuffle workflow:
- Ingests a Wazuh log when a specific rule is triggered
- Extracts IoCs from the log (ex. file hash)
- Sends the file hash to the VirusTotal API for enrichment
- Creates a case on TheHive
- Sends an email alert

![1](/assets/img/cyberlab/soc-automation/1.png){: width="800" height="400" }

The Wazuh AR rule quarantines an endpoint that had Mimikatz activity detected on it, independent of Shuffle. This essentially contains the host from the rest of the network and would require an incident responder to intervene and manually bring the host back online. 

**Flow**: Mimikatz executed → Log (Rule: 100002) sent to Wazuh → Wazuh Active Response triggered on host/ host quarantined → Email sent via Shuffle

Notice the timestamps of all the events; this happens almost instantaneously.

![2](/assets/img/cyberlab/soc-automation/2.png){: width="800" height="400" }

### Prerequisites 

This project is an extension of my (locally hosted) cybersecurity home lab. You do not need every single VM from my lab set up and configured, however the following is required:
- [Wazuh VM (v4.9.2)](/posts/wazuh)
- [Windows VM (I am using Windows 10)](/posts/ad-client)
    - Joining the VM to an Active Directory domain is not necessary
    - Sysmon must be installed and configured to forward logs to Wazuh
- [(optional) Ubuntu Desktop VM (24.04 LTS)](/posts/ubuntu)
    - Mainly used to SSH into the servers and access the web GUI of our apps. You can do this from the Windows VM, but I recommend using Ubuntu instead.

Of course, make sure these VMs can communicate with each other.

Additionally, we will need a custom Wazuh rule that detects Mimikatz activity on the Windows endpoint. See these pages:

- [Sysmon Deployment](/posts/sysmon-deployment)
    - You do not need the AD file share set up. Just follow the **Sysmon Download and Installation + Forwarding Sysmon Logs to Wazuh** sections.
- [Wazuh & Sysmon Telemetry Test](/posts/wazuh-telemetry)

### Topology

>Note: TheHive runs on a 14 day trial, so the VM associated with TheHive will be deleted soon. I will keep the Docker/Shuffle VM.
{: .prompt-info }

![3](/assets/img/cyberlab/soc-automation/3.png){: width="800" height="400" }

Again, you do not need to run every single VM for this project. The only VMs I ran were: OPNsense, Wazuh, TheHive, Docker, AD Client 1, and Ubuntu. OPNsense may not be necessary for your setup, however it serves as a router for all my VMs. 

This project is doable on the cloud, however you will need to be mindful of network configurations. I do not recommend going with a hybrid approach (some VMs on the cloud, some locally hosted) unless you know what you’re doing.

Since this is a full on prem setup, we will need 2 additional Ubuntu server VMs: one hosting TheHive and the other hosting Shuffle.

>Note: I am using VirtualBox Version 7.1: [https://www.virtualbox.org/wiki/Download_Old_Builds_7_1](https://www.virtualbox.org/wiki/Download_Old_Builds_7_1)
{: .prompt-info }

### Setup
- [Ubuntu Server VM Setup](/posts/ubuntu-server-vm)
- [Installing TheHive Dependencies](/posts/thehive-install)
- [TheHive Configuration](/posts/thehive-config)
- [Shuffle Installation via Docker](/posts/shuffle-docker)
- [Shuffle Workflow](/posts/shuffle-workflow)
- [Wazuh Active Response](/posts/wazuh-ar)