---
title: "Sysmon Deployment via GPO"
date: 2024-03-22 00:00:00 -0800
categories: [Cybersecurity Lab, Active Directory]
tags: [cybersecurity, homelab, active directory]
description: Using Group Policy Object to execute a script that installs Sysmon from the shared drive.
---

### Note

This exercise assumes you have completed the file share setup and have Wazuh up and running.

### Sysmon Download and Installation

System Monitor (Sysmon) is a powerful logging tool for Windows machines. It can log and monitor various system events and activity, such as process creation, network connections, file modifications and more. 

Download Sysmon from: [https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon](https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon)

>The latest version of Sysmon is v15.15 as of 3/22/25
{: .prompt-info }

![1](/assets/img/cyberlab/active-directory/sysmon-deployment/1.png){: width="800" height="400" }

Extract the zip file

![2](/assets/img/cyberlab/active-directory/sysmon-deployment/2.png){: width="800" height="400" }

We will need a Sysmon XML config to log certain events

I am using sysmonconfig.xml from [https://github.com/olafhartong/sysmon-modular](https://github.com/olafhartong/sysmon-modular)

Look for sysmonconfig.xml at the bottom of the page

![3](/assets/img/cyberlab/active-directory/sysmon-deployment/3.png){: width="800" height="400" }

Click raw

![4](/assets/img/cyberlab/active-directory/sysmon-deployment/4.png){: width="800" height="400" }

Right click on the page and save as sysmonconfig.xml i

Save it in the Sysmon directory (the extracted zip)

![5](/assets/img/cyberlab/active-directory/sysmon-deployment/5.png){: width="600" height="400" }

Open PowerShell as administrator

Run `.\Sysmon64.exe -i .\sysmonconfig.xml`

![6](/assets/img/cyberlab/active-directory/sysmon-deployment/6.png){: width="800" height="400" }

Check services to make sure Sysmon is running

It will be listed as Sysmon64

![7](/assets/img/cyberlab/active-directory/sysmon-deployment/7.png){: width="800" height="400" }

### Forwarding Sysmon Logs to Wazuh

We will forward our Sysmon logs to Wazuh so we can view them in a centralized dashboard

Head to `C:\Program Files (x86)\ossec-agent`

![8](/assets/img/cyberlab/active-directory/sysmon-deployment/8.png){: width="800" height="400" }

Make a backup of ossec.conf just in case

![9](/assets/img/cyberlab/active-directory/sysmon-deployment/9.png){: width="800" height="400" }

Open **ossec.conf** (not the backup)

Scroll down until you see log analysis and add these rules

```xml
<localfile>
    <location>Microsoft-Windows-Sysmon/Operational</location>
    <log_format>eventchannel</log_format>
</localfile>

<localfile>
    <location>Microsoft-Windows-PowerShell/Operational</location>
    <log_format>eventchannel</log_format>
</localfile>
```

![10](/assets/img/cyberlab/active-directory/sysmon-deployment/10.png){: width="800" height="400" }

Save the file

Restart Wazuh from the Services menu

![11](/assets/img/cyberlab/active-directory/sysmon-deployment/11.png){: width="800" height="400" }

Head to the Wazuh dashboard (I am using the Ubuntu VM for this)

We should see some logs generated by Sysmon or PowerShell

There are a lot of false positives, so it still needs some tuning

![12](/assets/img/cyberlab/active-directory/sysmon-deployment/12.png){: width="800" height="400" }

### Security Group and File Share Setup

We will create a new security group with all of our workstations so we can automate the Sysmon deployment

On the DC VM, Head to **AD Users and Computers**

Right Click **Security Groups > New > Object**

Set a name for this group (I named mine Software Deployment)

![13](/assets/img/cyberlab/active-directory/sysmon-deployment/13.png){: width="500" height="300" }

Right click on the group and click **Properties > Members > Add**

Click on Object Types

![14](/assets/img/cyberlab/active-directory/sysmon-deployment/14.png){: width="500" height="400" }

Only check Computers and click OK

![15](/assets/img/cyberlab/active-directory/sysmon-deployment/15.png){: width="500" height="400" }

Enter the workstation names and click check names to verify them

In this case, I only have Bob-Workstation and Alice-Workstation

Click Apply and OK

![16](/assets/img/cyberlab/active-directory/sysmon-deployment/16.png){: width="500" height="400" }

In the Shares directory (**\\\\DOMAINCONTROLLE** or **:S** as we have set up) make a new folder called Software Deployment

Copy the Sysmon folder containing the Sysmon application and config file into the Software deployment folder

![17](/assets/img/cyberlab/active-directory/sysmon-deployment/17.png){: width="800" height="400" }

Double check to make sure all the files are there

![18](/assets/img/cyberlab/active-directory/sysmon-deployment/18.png){: width="800" height="400" }

Right click the Shares folder > **Properties > Security > Advanced**

![19](/assets/img/cyberlab/active-directory/sysmon-deployment/19.png){: width="800" height="400" }

Click Add

![20](/assets/img/cyberlab/active-directory/sysmon-deployment/20.png){: width="700" height="400" }

Click Select a principal 

Enter the security group name and check names (Software Deployment)

Click OK

![21](/assets/img/cyberlab/active-directory/sysmon-deployment/21.png){: width="500" height="400" }

This group only needs these permissions (Read and execute)

Click OK

![22](/assets/img/cyberlab/active-directory/sysmon-deployment/22.png){: width="800" height="400" }

Click Apply

![23](/assets/img/cyberlab/active-directory/sysmon-deployment/23.png){: width="800" height="400" }

Head to the Shares folder and right click on the Software Deployment folder 

Head to **Properties > Security > Advanced Permissions**

![24](/assets/img/cyberlab/active-directory/sysmon-deployment/24.png){: width="800" height="400" }

The Software Deployment group should have read and execute permissions for the share

We can leave inherited permissions enabled for now

![25](/assets/img/cyberlab/active-directory/sysmon-deployment/25.png){: width="800" height="400" }

Right click the Software Deployment folder > **Properties > Sharing > Advanced Sharing**

![26](/assets/img/cyberlab/active-directory/sysmon-deployment/26.png){: width="800" height="400" }

Check Share this folder and then add permissions

![27](/assets/img/cyberlab/active-directory/sysmon-deployment/27.png){: width="400" height="400" }

Add the Software Deployment group with read permissions 

![28](/assets/img/cyberlab/active-directory/sysmon-deployment/28.png){: width="400" height="400" }

Launch one of the client VMs

We should be able to access the Sysmon folder via the share

![29](/assets/img/cyberlab/active-directory/sysmon-deployment/29.png){: width="800" height="400" }

### PowerShell Script + Test

This is a PowerShell script that copies the Sysmon directory from the file share, puts it in the C: drive of the workstations, and then runs the same command we used to install Sysmon with the config file. It also creates a log file and adds to the file when the installation succeeds or fails (useful for troubleshooting).

On the DC VM, Open PowerShell ISE 

Paste the script and adjust the file paths (only the first 6 lines) according to your setup:

```powershell
# Define paths
$NetworkPath = "\\DomainController\Shares\Software Deployment\Sysmon"
$LocalPath = "C:\Sysmon"
$SysmonExe = "$LocalPath\Sysmon64.exe"
$ConfigFile = "$LocalPath\sysmonconfig.xml"
$LogFile = "C:\Sysmon\SysmonDeploymentLog.txt"

# Ensure the local directory exists
if (!(Test-Path -Path $LocalPath)) {
    New-Item -ItemType Directory -Path $LocalPath -Force
    "Created directory: $LocalPath" | Out-File -FilePath $LogFile -Append
}

# Start writing to the log file
"Starting Sysmon deployment..." | Out-File -FilePath $LogFile -Append

# Copy Sysmon files from the network share to the local path
"Copying Sysmon files..." | Out-File -FilePath $LogFile -Append
Copy-Item -Path "$NetworkPath\*" -Destination $LocalPath -Recurse -Force

# Verify if Sysmon64 is already installed
$SysmonService = Get-Service -Name "Sysmon64" -ErrorAction SilentlyContinue
if ($SysmonService) {
    "Sysmon64 is already installed. Starting service..." | Out-File -FilePath $LogFile -Append
    Start-Service -Name "Sysmon64"
    Exit 0
}

# Install Sysmon with EULA acceptance
"Installing Sysmon..." | Out-File -FilePath $LogFile -Append
Start-Process -FilePath $SysmonExe -ArgumentList "-accepteula -i $ConfigFile" -Wait -NoNewWindow

# Wait for a few seconds to allow Sysmon64 to start
Start-Sleep -Seconds 5

# Verify installation
$SysmonService = Get-Service -Name "Sysmon64" -ErrorAction SilentlyContinue
if ($SysmonService -and $SysmonService.Status -eq "RUNNING") {
    "Sysmon64 installed and running successfully." | Out-File -FilePath $LogFile -Append
} else {
    "Sysmon64 installation failed." | Out-File -FilePath $LogFile -Append
    Exit 1
}

"Sysmon64 deployment script completed successfully." | Out-File -FilePath $LogFile -Append

```

Click **File > Save as DeploySysmon.ps1** (save this in the Sysmon directory in the Software Deployment file share)

![30](/assets/img/cyberlab/active-directory/sysmon-deployment/30.png){: width="800" height="400" }

Head to one of the client VMs

The PS script should be viewable in the share

![31](/assets/img/cyberlab/active-directory/sysmon-deployment/31.png){: width="800" height="400" }

**Testing the Script (On the DC VM)**

Since we already installed Sysmon on the DC, run `sysmon64 -u` to uninstall first

Then run the script

![32](/assets/img/cyberlab/active-directory/sysmon-deployment/32.png){: width="800" height="400" }

**Verifying that the script was successful**

Notice that the Sysmon files are copied to the C drive

![33](/assets/img/cyberlab/active-directory/sysmon-deployment/33.png){: width="800" height="400" }

The log output should look like this:

![34](/assets/img/cyberlab/active-directory/sysmon-deployment/34.png){: width="800" height="400" }

and Sysmon64 should display on the list of running services

![35](/assets/img/cyberlab/active-directory/sysmon-deployment/35.png){: width="800" height="400" }

**Test on Client VM**

Open PowerShell as administrator

Navigate to the Software Deployment Share and execute the script

The script ran successfully

![36](/assets/img/cyberlab/active-directory/sysmon-deployment/36.png){: width="800" height="400" }

Sysmon folder created on the C drive

![37](/assets/img/cyberlab/active-directory/sysmon-deployment/37.png){: width="800" height="400" }

Log file gives us the success message

![38](/assets/img/cyberlab/active-directory/sysmon-deployment/38.png){: width="800" height="400" }

and Sysmon64 is listed as a running service

![39](/assets/img/cyberlab/active-directory/sysmon-deployment/39.png){: width="800" height="400" }

### Deploy Sysmon via GPO

Since the PowerShell script works and is shared to our AD computers, the users can just navigate to the share and execute the script to install Sysmon.

That's boring so we are going to have the PowerShell script execute upon system startup (automation!)

This will also show how dangerous it would be if a bad actor got access to a Domain Admin account and created a malicious script to run on system startup.

First, uninstall Sysmon and delete the Sysmon folder from the C: drive of the client VM (the script works, now let's see if the GPO will work)

On the DC VM, Head to Group Policy Management

Right click **Group Policy Objects > New > Enter a name**

![40](/assets/img/cyberlab/active-directory/sysmon-deployment/40.png){: width="800" height="400" }

Click the GPO and under security filtering, add the Software Deployment group

![41](/assets/img/cyberlab/active-directory/sysmon-deployment/41.png){: width="500" height="400" }

Drag the new GPO to the root domain (cyber.lab)

![42](/assets/img/cyberlab/active-directory/sysmon-deployment/42.png){: width="800" height="400" }

Right click the new GPO > Edit and head to **Computer Configuration > Policies > Windows Settings > Scripts (Startup/Shutdown)**

Click Startup and head to PowerShell Scripts

Add script, and put the full path of the PS script under Script Name (**\\\\DomainController\Shares\Software Deployment\Sysmon\DeploySysmon.ps1**)

![43](/assets/img/cyberlab/active-directory/sysmon-deployment/43.png){: width="800" height="400" }

**Testing the GPO**

Reboot the client VM (I am on Bob-Workstation)

Notice that the Sysmon folder is created

![44](/assets/img/cyberlab/active-directory/sysmon-deployment/44.png){: width="800" height="400" }

Installation successful

![45](/assets/img/cyberlab/active-directory/sysmon-deployment/45.png){: width="800" height="400" }

and Sysmon64 running

![46](/assets/img/cyberlab/active-directory/sysmon-deployment/46.png){: width="800" height="400" }

I launched my 2nd client VM (Alice)

Pay attention to the date modified label of the folder (12:43)

![47](/assets/img/cyberlab/active-directory/sysmon-deployment/47.png){: width="800" height="400" }

Add these rules to ossec.conf if you have not already done so.

```xml
<localfile>
    <location>Microsoft-Windows-Sysmon/Operational</location>
    <log_format>eventchannel</log_format>
</localfile>

<localfile>
    <location>Microsoft-Windows-PowerShell/Operational</location>
    <log_format>eventchannel</log_format>
</localfile>
```

>We can modify this file using GPO as well, but the main focus here is actually installing a service.
{: .prompt-info }

### Wazuh Dashboard

Again, lots of false positives, we can tune it later

I am ooking at high severity alerts (11-14)

Notice we are getting Sysmon events on Wazuh from all workstations

![48](/assets/img/cyberlab/active-directory/sysmon-deployment/48.png){: width="800" height="400" }

This is a log that was generated by the startup script running

Keep in mind that the PS script creates a folder in the C: drive of the system, so this will generate a log

The timestamp matches roughly when the folder was created and when ossec.conf was modified (UTC time is ahead by 4 hours)

![49](/assets/img/cyberlab/active-directory/sysmon-deployment/49.png){: width="800" height="400" }

![50](/assets/img/cyberlab/active-directory/sysmon-deployment/50.png){: width="800" height="400" }

